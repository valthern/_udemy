@page "/usuarios/editar/{UsuarioId}"
@inject RepositorioUsuarios repositorio
@inject SweetAlertService swal

<h3>Editar Usuario</h3>

@if (roles is null)
{
    <p>Cargando...</p>
}
else
{
    <div class="form-inline">
        <select class="form-select mb-2" @bind="rolSeleccionado">
            <option value="0">---Seleccione un rol---</option>
            @foreach (var rol in roles)
            {
                <option value="@rol.Nombre">@rol.Nombre</option>
            }
        </select>

        <button class="btn btn-info mb-2" @onclick="AsignarRol">Asignar Rol</button>
        <button class="btn btn-danger mb-2" @onclick="RemoverRol">Remover Rol</button>
    </div>
}

@code {
    [Parameter]
    public string UsuarioId { get; set; } = null!;
    private List<RolDTO>? roles;
    private string rolSeleccionado = "0";

    protected override async Task OnInitializedAsync() => roles = await repositorio.GetRoles();

    private async Task AsignarRol() {
        var esValido = await ValidarEditarRol();
        if (!esValido) return;

        var rolDTO = new EditarRolDTO { Rol = rolSeleccionado, UsuarioId = UsuarioId };
        await repositorio.AsignarRolUsuario(rolDTO);
        await swal.FireAsync("Exitoso", "Operación realizada con éxito", SweetAlertIcon.Success);
    }

    private async Task RemoverRol() {
        var esValido = await ValidarEditarRol();
        if (!esValido) return;

        var rolDTO = new EditarRolDTO { Rol = rolSeleccionado, UsuarioId = UsuarioId };
        await repositorio.RemoverRolUsuario(rolDTO);
        await swal.FireAsync("Exitoso", "Operación realizada con éxito", SweetAlertIcon.Success);
    }

    private async Task<bool> ValidarEditarRol()
    {
        if (rolSeleccionado == "0")
        {
            await swal.FireAsync("Error", "Debe seleccionar un rol", SweetAlertIcon.Error);
            return false;
        }

        return true;
    }

    // private async Task EditarRol(string url)
    // {


    //     var rolDTO = new EditarRolDTO { Rol = rolSeleccionado, UsuarioId = UsuarioId };
    //     var httpResponse = await repositorio.Post<EditarRolDTO>(url, rolDTO);

    //     if (httpResponse.Error)
    //     {
    //         var mensajeError = await httpResponse.ObtenerMensajeError();
    //         await swal.FireAsync("Error", mensajeError, SweetAlertIcon.Error);
    //     }
    //     else
    //         await swal.FireAsync("Exitoso", "Operación realizada con éxito", SweetAlertIcon.Success);
    // }
}
